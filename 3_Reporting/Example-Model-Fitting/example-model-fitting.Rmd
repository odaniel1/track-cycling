---
title: "Introduction to the Track Cycling Modelling Workflow"
author: "Owen Daniel"
output:
  tufte::tufte_html:
    toc: true
    toc_depth: 1
---

```{r setup, include=FALSE, echo=FALSE}
# Set up options copied from Bob Carpenter's markdown template, eg.
# https://github.com/stan-dev/example-models/blob/master/knitr/

options(htmltools.dir.version = FALSE)
options(digits = 2)

library(knitr)
knitr::opts_chunk$set(root.dir = './../../')
knitr::opts_knit$set(root.dir = './../../')
knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'))
knitr::opts_chunk$set(comment = "")

library(tidyverse)

library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores(logical = FALSE))

library(fs)

library(tufte)

ggtheme_tufte <- function() {
  theme(plot.background =
          element_rect(fill = "#fffff8",
                       colour = "#fffff8",
                       size = 0.5,
                       linetype = "solid"),
        plot.margin=unit(c(1, 1, 0.5, 0.5), "lines"),
        panel.background =
          element_rect(fill = "#fffff8",
                       colour = "#fffff8",
                       size = 0.5,
                       linetype = "solid"),
        panel.grid.major = element_line(colour = "white", size = 1, linetype="dashed"),
          # blank(),
        panel.grid.minor = element_blank(),
        legend.box.background =
          element_rect(fill = "#fffff8",
                       colour = "#fffff8",
                       linetype = "solid"),
        axis.ticks = element_blank(),
        axis.text = element_text(family = "Palatino", size = 16),
        axis.title.x = element_text(family = "Palatino", size = 20,
                                    margin = margin(t = 15, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(family = "Palatino", size = 18,
                                    margin = margin(t = 0, r = 15, b = 0, l = 0)),
        strip.background = element_rect(fill = "#fffff8",
                                        colour = "#fffff8",
                                        linetype = "solid"),
        strip.text = element_text(family = "Palatino", size = 16),
        legend.text = element_text(family = "Palatino", size = 16),
        legend.title = element_text(family = "Palatino", size = 16,
                                    margin = margin(b = 5)),
        legend.background = element_rect(fill = "#fffff8",
                                        colour = "#fffff8",
                                        linetype = "solid"),
        legend.key = element_rect(fill = "#fffff8",
                                        colour = "#fffff8",
                                        linetype = "solid")
  )
}

printf <- function(msg = "%5.3f", ...) {
  cat(sprintf(msg, ...))
}
```

# Introduction {-}
This package has been designed as a collection of tools to:

* Obtain, and clean data from UCI track cycling events (currently supporting the Individual and Team Sprint disciplines),
* Define a Bayesian workflow and pre-defined Stan models for use with the data. 

In this notebook we provide a worked example of fitting one of the models as an example of the intended workflow.

# Directory structure
The tree diagram below demonstrates the structure of the directory, which follows the modelling workflow. Scripts or functions are located in the sub-directory specific to the part of the workflow they are used in.
```{r, echo=FALSE}
dir_tree(".", recurse = 1)
```

# Acquiring race data
```{r}
source("./0_Raw-Data/Functions/generate_race_lookup.R")
```

# Reading race data
For the purposes of this example we will fit a model for the Men's Individual sprint, for which we use the Bradley-Terry model for pairwise competitions.

We will exclude data from qualifying rounds since these take the form of a *flying lap*, rather than match sprints. We use the data from the 2018/19 series to fit the model, and then evaluate it against the results of the 2019 Track World Cup which took place in Pruszkow, Poland.

```{r, message = FALSE, warning = FALSE}
race_lookup <- generate_race_lookup() %>%
    filter(
    season == "2018/19",
    location_country != "Poland",
    race == "Individual Sprint",
    gender == "Men",
    !(round %in% c("Qualifying"))
  )
```

# Running Stan models
```{r, message = FALSE, warning = FALSE, results="hide"}
source("./2_Modelling/Functions/fit_stan_models.R")
dirichlet_path <- "./2_Modelling/Stan-Models/Bradley-Terry-Dirichlet"
dirichlet_model <- compile_model(dirichlet_path)
dirichlet_fit <- fit_model(race_lookup, dirichlet_model, dirichlet_path)
```

# Accessing Model Elements
The object `dirichlet_fit` returned is a list with two elements. The first is the fitted stan model, and the second is the list containing the parameters originally provided to fit the model.

In this example we are going to extract from the model the posterior samples for the individual rider ratings. 
```{r}
samples <- rstan::extract(dirichlet_fit$stan_fit)$rating

colnames(samples) <- 1:ncol(samples)

samples <- samples %>%
  as_tibble %>%
  mutate(sample_id = 1:n()) %>%
  gather("rider_id", "rating", -sample_id) %>%
  mutate(rider_id = as.numeric(rider_id))
```
We now add the rider lookup which was in the initial model parameters.
```{r}
samples <- samples %>% left_join(dirichlet_fit$parameters$riders)
```

Finally we will produce a summary of the data.
```{r}
rider_rankings <- samples %>%
  group_by(rider, rider_id) %>%
  summarise(
    ranking_10 = quantile(rating, 0.1),
    ranking_50 = quantile(rating, 0.5),
    ranking_90 = quantile(rating, 0.9)
  )

rider_rankings %>% arrange(desc(ranking_50)) %>% head(20)

```

# Evaluating model performance
```{r, message = FALSE, warning = FALSE}
race_lookup <- generate_race_lookup() %>%
    filter(
    season == "2018/19",
    location_country == "Poland",
    race == "Individual Sprint",
    gender == "Men",
    !(round %in% c("Qualifying"))
  )

test_sprints <- format_individual_sprint_data(race_lookup)$sprints

test_sprints <- test_sprints %>%
  crossing(sample_id =1:8000)

test_sprints <- test_sprints %>%
  left_join(samples %>% select(sample_id, rider_0 = rider, rating_0 = rating )) %>%
  left_join(samples %>% select(sample_id, rider_1 = rider, rating_1 = rating ))

test_sprints <- test_sprints %>%
  mutate(
    prob_1_wins = rating_1 / (rating_1 + rating_0),
    log_loss = ifelse(winner == 1, log(prob_1_wins), log(1-prob_1_wins))
  )

log_loss_samples <- test_sprints %>% group_by(sample_id) %>%
  summarise(
    mean_log_loss = mean(log_loss, na.rm = TRUE)
  )

ggplot(log_loss_samples, aes(mean_log_loss)) + geom_histogram() +
  geom_vline(xintercept = log(0.5), linetype = 'dashed', color = 'hotpink')
```

```{r}
ggplot(test_sprints, aes(round, log_loss)) + geom_boxplot() +
  coord_cartesian(ylim = c(-1.5,0)) +
  geom_hline(yintercept = log(0.5), linetype = 'dashed', color = 'hotpink') +
  geom_hline(
    yintercept = mean(log_loss_samples$mean_log_loss),
    linetype = "dashed", color = "blue"
  ) +
  geom_hline(
    yintercept = median(log_loss_samples$mean_log_loss),
    color = "blue"
  )
```
# Session information  {-}

<div style="font-size:90%">
```{r}
sessionInfo()
```
</div>